import React, { useEffect, useState, useRef } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Shield, ShieldAlert, User, AlertTriangle, ArrowRight, Lock, Unlock, Database, Globe } from 'lucide-react';
import { DemoControls } from '../App';

type Stage = 'SAFE_LOGIN' | 'NORMAL_POST' | 'INTERCEPT' | 'CONVERT_GET' | 'ATTACK_SUCCESS' | 'PROTECTION' | 'SAFE_AGAIN';

const STAGE_DURATION = {
  SAFE_LOGIN: 3000,
  NORMAL_POST: 4000,
  INTERCEPT: 3000,
  CONVERT_GET: 4000,
  ATTACK_SUCCESS: 5000,
  PROTECTION: 4000,
  SAFE_AGAIN: 0
};

interface APIExploitationDemoProps {
  controls: DemoControls;
}

export function APIExploitationDemo({ controls }: APIExploitationDemoProps) {
  const [stage, setStage] = useState<Stage>('SAFE_LOGIN');
  const [userBalance, setUserBalance] = useState(1000);
  const [attackerBalance, setAttackerBalance] = useState(0);
  const [protectionEnabled, setProtectionEnabled] = useState(false);
  const [requestType, setRequestType] = useState<'POST' | 'GET'>('POST');
  const [showInterception, setShowInterception] = useState(false);
  const [showExplosion, setShowExplosion] = useState(false);

  const timerRef = useRef<number | null>(null);

  useEffect(() => {
    if (!controls.isPlaying) return;

    const advance = () => {
      switch (stage) {
        case 'SAFE_LOGIN':
          setStage('NORMAL_POST');
          break;
        case 'NORMAL_POST':
          setStage('INTERCEPT');
          break;
        case 'INTERCEPT':
          setStage('CONVERT_GET');
          break;
        case 'CONVERT_GET':
          setStage(protectionEnabled ? 'PROTECTION' : 'ATTACK_SUCCESS');
          break;
        case 'ATTACK_SUCCESS':
          setStage('PROTECTION');
          break;
        case 'PROTECTION':
          setStage('SAFE_AGAIN');
          break;
        default:
          break;
      }
    };

    if (stage !== 'SAFE_AGAIN') {
      timerRef.current = window.setTimeout(advance, STAGE_DURATION[stage]);
    }

    return () => {
      if (timerRef.current) clearTimeout(timerRef.current);
    };
  }, [stage, protectionEnabled, controls.isPlaying]);

  useEffect(() => {
    switch (stage) {
      case 'SAFE_LOGIN':
        setUserBalance(1000);
        setAttackerBalance(0);
        setRequestType('POST');
        setShowInterception(false);
        setShowExplosion(false);
        break;
      case 'NORMAL_POST':
        setRequestType('POST');
        break;
      case 'INTERCEPT':
        setShowInterception(true);
        break;
      case 'CONVERT_GET':
        setRequestType('GET');
        break;
      case 'ATTACK_SUCCESS':
        if (!protectionEnabled) {
          const interval = setInterval(() => {
            setUserBalance(prev => Math.max(0, prev - 50));
            setAttackerBalance(prev => prev + 50);
          }, 100);
          setTimeout(() => clearInterval(interval), 2000);
        }
        break;
      case 'PROTECTION':
        setShowExplosion(true);
        setTimeout(() => setShowExplosion(false), 1500);
        break;
    }
  }, [stage, protectionEnabled]);

  useEffect(() => {
    if (!controls.isPlaying) {
      setStage('SAFE_LOGIN');
      setProtectionEnabled(false);
      if (timerRef.current) clearTimeout(timerRef.current);
    }
  }, [controls.isPlaying]);

  const handleToggleProtection = () => {
    setProtectionEnabled(!protectionEnabled);
    setStage('SAFE_LOGIN');
  };

  const handleReset = () => {
    setStage('SAFE_LOGIN');
    setProtectionEnabled(false);
  };

  return (
    <div className="min-h-screen bg-orange-50 font-sans text-slate-900 flex flex-col">
      {/* Header */}
      <header className="bg-white border-b border-slate-200 p-4 shadow-sm">
        <div className="max-w-6xl mx-auto">
          <div className="text-center mb-4">
            <h1 className="text-2xl md:text-3xl font-bold text-slate-800 tracking-tight">
              <span className="text-orange-600">API Exploitation</span> Demo
            </h1>
            <p className="text-slate-600 mt-1">POST to GET Conversion Attack</p>
          </div>
          
          {/* Security Status */}
          <div className={`p-3 rounded-lg border-2 transition-all duration-500 ${
            protectionEnabled ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300'
          }`}>
            <div className="flex items-center justify-center gap-3">
              {protectionEnabled ? (
                <>
                  <Shield className="w-5 h-5 text-green-600" />
                  <span className="font-bold text-green-800">üõ°Ô∏è API PROTECTION ENABLED</span>
                </>
              ) : (
                <>
                  <ShieldAlert className="w-5 h-5 text-red-600" />
                  <span className="font-bold text-red-800">‚ö†Ô∏è NO API PROTECTION - Vulnerable to Attacks</span>
                </>
              )}
            </div>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="flex-1 p-4 md:p-8">
        <div className="max-w-6xl mx-auto">
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
            {/* User Browser */}
            <div className="order-1">
              <UserBrowser balance={userBalance} stage={stage} />
            </div>

            {/* Network/Attack Flow */}
            <div className="order-3 lg:order-2 flex flex-col gap-6">
              <NetworkFlow 
                stage={stage} 
                requestType={requestType}
                showInterception={showInterception}
                protectionEnabled={protectionEnabled}
                showExplosion={showExplosion}
              />
              
              {stage === 'SAFE_AGAIN' && (
                <div className="bg-white rounded-2xl border-2 border-slate-200 p-4 text-center">
                  <button
                    onClick={handleToggleProtection}
                    className={`px-4 py-2 rounded-lg font-bold transition-all duration-300 mr-2 ${
                      protectionEnabled ? 'bg-red-100 text-red-700 hover:bg-red-200' : 'bg-green-100 text-green-700 hover:bg-green-200'
                    }`}
                  >
                    {protectionEnabled ? 'Disable Protection' : 'Enable Protection'}
                  </button>
                  <button
                    onClick={handleReset}
                    className="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg font-bold hover:bg-blue-200 transition-all duration-300"
                  >
                    Restart Demo
                  </button>
                </div>
              )}
            </div>

            {/* Server/Attacker */}
            <div className="order-2 lg:order-3">
              <ServerZone balance={attackerBalance} stage={stage} />
            </div>
          </div>
        </div>
      </main>

      {/* Narrator Bar */}
      <NarratorBar stage={stage} protectionEnabled={protectionEnabled} />
    </div>
  );
}

function UserBrowser({ balance, stage }: { balance: number; stage: Stage }) {
  return (
    <div className="bg-white rounded-2xl border-4 border-blue-200 shadow-xl overflow-hidden">
      {/* Browser Bar */}
      <div className="bg-blue-50 p-3 flex items-center justify-between border-b-2 border-blue-200">
        <div className="flex items-center gap-2">
          <div className="w-3 h-3 rounded-full bg-red-400" />
          <div className="w-3 h-3 rounded-full bg-yellow-400" />
          <div className="w-3 h-3 rounded-full bg-green-400" />
        </div>
        <div className="bg-white px-3 py-1 rounded-full text-xs font-mono text-slate-600 flex items-center gap-1">
          <Lock className="w-3 h-3" /> mybank.com
        </div>
      </div>
      
      {/* Bank Content */}
      <div className="p-6">
        <div className="text-center mb-6">
          <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <User className="w-8 h-8 text-blue-600" />
          </div>
          <h3 className="text-lg font-bold text-slate-800">John's Account</h3>
          <p className="text-slate-500 text-sm">Logged in securely</p>
        </div>

        <div className="bg-slate-50 rounded-xl p-4 text-center mb-4">
          <p className="text-sm text-slate-500 uppercase tracking-wider font-semibold mb-2">
            Balance
          </p>
          <motion.div
            key={balance}
            initial={balance < 1000 ? { scale: 1.1, color: '#ef4444' } : {}}
            animate={{ scale: 1, color: '#1e293b' }}
            className="text-3xl font-black text-slate-800"
          >
            ${balance}
          </motion.div>
        </div>

        {stage === 'NORMAL_POST' && (
          <motion.div
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            className="bg-blue-100 border-2 border-blue-300 rounded-lg p-3 text-center"
          >
            <p className="text-sm font-bold text-blue-800">Making secure POST request...</p>
          </motion.div>
        )}
      </div>
    </div>
  );
}

function NetworkFlow({ stage, requestType, showInterception, protectionEnabled, showExplosion }: {
  stage: Stage;
  requestType: 'POST' | 'GET';
  showInterception: boolean;
  protectionEnabled: boolean;
  showExplosion: boolean;
}) {
  return (
    <div className="bg-slate-100 rounded-2xl border-2 border-slate-200 border-dashed p-4 min-h-[300px] flex flex-col items-center justify-center relative">
      <p className="absolute top-2 text-xs font-bold text-slate-400 uppercase tracking-wider">
        Network Request Flow
      </p>

      <AnimatePresence>
        {stage === 'NORMAL_POST' && (
          <motion.div
            initial={{ opacity: 0, scale: 0.8 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 0.8 }}
            className="bg-green-100 border-2 border-green-400 rounded-lg p-4 text-center"
          >
            <Globe className="w-8 h-8 text-green-600 mx-auto mb-2" />
            <p className="font-bold text-green-800">POST Request</p>
            <p className="text-sm text-green-600">Secure & Encrypted</p>
          </motion.div>
        )}

        {showInterception && (
          <motion.div
            initial={{ opacity: 0, x: -50 }}
            animate={{ opacity: 1, x: 0 }}
            className="bg-red-500 text-white rounded-lg p-4 text-center border-4 border-red-700 relative"
          >
            <AlertTriangle className="w-8 h-8 mx-auto mb-2 animate-pulse" />
            <p className="font-bold">‚ö†Ô∏è INTERCEPTED!</p>
            <p className="text-sm">Attacker captures request</p>
            <div className="absolute -top-2 -right-2 bg-yellow-400 text-black text-xs px-2 py-1 rounded-full animate-bounce">
              HACKER
            </div>
          </motion.div>
        )}

        {stage === 'CONVERT_GET' && (
          <motion.div
            initial={{ opacity: 0, scale: 0.8 }}
            animate={{ opacity: 1, scale: 1 }}
            className="bg-orange-100 border-2 border-orange-400 rounded-lg p-4 text-center"
          >
            <ArrowRight className="w-8 h-8 text-orange-600 mx-auto mb-2" />
            <p className="font-bold text-orange-800">Converting POST ‚Üí GET</p>
            <code className="text-xs bg-orange-200 px-2 py-1 rounded mt-2 block">
              /api/transfer?amount=500&to=attacker
            </code>
          </motion.div>
        )}

        {showExplosion && (
          <motion.div
            initial={{ scale: 0 }}
            animate={{ scale: [0, 1.2, 1] }}
            exit={{ scale: 0 }}
            className="bg-green-500 text-white rounded-full p-6 text-center"
          >
            <Shield className="w-12 h-12 mx-auto mb-2" />
            <p className="font-bold">BLOCKED!</p>
          </motion.div>
        )}
      </AnimatePresence>

      <div className="mt-4 text-center">
        <div className={`inline-block px-3 py-1 rounded-full text-sm font-bold ${
          requestType === 'POST' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
        }`}>
          {requestType} Request
        </div>
      </div>
    </div>
  );
}

function ServerZone({ balance, stage }: { balance: number; stage: Stage }) {
  return (
    <div className="bg-white rounded-2xl border-4 border-red-200 shadow-xl overflow-hidden">
      {/* Server Header */}
      <div className="bg-red-50 p-3 flex items-center justify-between border-b-2 border-red-200">
        <div className="flex items-center gap-2">
          <Database className="w-4 h-4 text-red-600" />
          <span className="text-sm font-bold text-red-800">Bank Server</span>
        </div>
        <div className={`w-3 h-3 rounded-full ${stage === 'ATTACK_SUCCESS' ? 'bg-red-500 animate-pulse' : 'bg-green-500'}`} />
      </div>
      
      {/* Server Content */}
      <div className="p-6">
        <div className="text-center mb-6">
          <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <Database className="w-8 h-8 text-red-600" />
          </div>
          <h3 className="text-lg font-bold text-slate-800">Server Processing</h3>
        </div>

        {stage === 'ATTACK_SUCCESS' && balance > 0 && (
          <div className="bg-red-50 rounded-xl p-4 text-center mb-4">
            <p className="text-sm text-red-500 uppercase tracking-wider font-semibold mb-2">
              Stolen Funds
            </p>
            <motion.div
              key={balance}
              initial={{ scale: 1.1, color: '#ef4444' }}
              animate={{ scale: 1, color: '#dc2626' }}
              className="text-3xl font-black text-red-600"
            >
              ${balance}
            </motion.div>
          </div>
        )}

        <div className="space-y-2">
          <div className={`h-2 rounded-full overflow-hidden ${
            stage === 'ATTACK_SUCCESS' ? 'bg-red-100' : 'bg-slate-100'
          }`}>
            <div className={`h-full w-3/4 ${
              stage === 'ATTACK_SUCCESS' ? 'bg-red-400' : 'bg-slate-200'
            }`} />
          </div>
          <div className={`h-2 rounded-full overflow-hidden ${
            stage === 'ATTACK_SUCCESS' ? 'bg-red-100' : 'bg-slate-100'
          }`}>
            <div className={`h-full w-1/2 ${
              stage === 'ATTACK_SUCCESS' ? 'bg-red-400' : 'bg-slate-200'
            }`} />
          </div>
        </div>
      </div>
    </div>
  );
}

function NarratorBar({ stage, protectionEnabled }: { stage: Stage; protectionEnabled: boolean }) {
  const getMessage = () => {
    switch (stage) {
      case 'SAFE_LOGIN':
        return "üë§ John logs into his bank account safely. Everything looks normal...";
      case 'NORMAL_POST':
        return "üîí John makes a secure POST request to transfer money. The request is encrypted and safe.";
      case 'INTERCEPT':
        return "üïµÔ∏è An attacker intercepts the network traffic and captures John's request!";
      case 'CONVERT_GET':
        return "‚ö° The attacker converts the secure POST request into a dangerous GET request with visible parameters!";
      case 'ATTACK_SUCCESS':
        return protectionEnabled 
          ? "üõ°Ô∏è The server validates the request method and blocks the malicious GET request!"
          : "üí∏ Attack successful! The server processes the malicious GET request and transfers John's money!";
      case 'PROTECTION':
        return "üîê With proper API protection, the server only accepts POST requests for sensitive operations.";
      case 'SAFE_AGAIN':
        return "‚úÖ Security measures prevent POST to GET conversion attacks. Always validate request methods!";
      default:
        return "";
    }
  };

  return (
    <div className={`p-4 border-t-4 transition-all duration-500 ${
      stage === 'ATTACK_SUCCESS' && !protectionEnabled ? 'bg-red-100 border-red-400' :
      stage === 'PROTECTION' || (stage === 'ATTACK_SUCCESS' && protectionEnabled) ? 'bg-green-100 border-green-400' :
      'bg-blue-100 border-blue-400'
    }`}>
      <div className="max-w-6xl mx-auto text-center">
        <p className="text-lg font-semibold text-slate-800">
          {getMessage()}
        </p>
      </div>
    </div>
  );
}